<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor - {{ meta.name }}</title>
    <link rel="icon" href="/static/icon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/askew_theme.css">
    <style>
        .intent-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .intent-item:hover { border-color: var(--text-muted); background: var(--bg-hover); }
        .intent-item.active { border-color: var(--accent-lilac); background: rgba(216, 180, 254, 0.05); }

        .tag-badge {
            background: var(--accent-lilac); color: black;
            font-size: 11px; padding: 2px 6px; border-radius: 4px;
            font-weight: 600; text-transform: uppercase;
        }
        
        /* Editor Panes */
        .editor-container { display: flex; height: 100vh; overflow: hidden; }
        .list-pane { width: 300px; border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; background: var(--bg-sidebar); }
        .edit-pane { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-body); }
        
        .field-group { margin-bottom: 20px; }
        .array-input { display: flex; gap: 8px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <!-- Sidebar (Mini) -->
    <div class="sidebar" style="width: 60px; align-items: center; padding: 16px 0;">
        <div class="brand-icon" style="margin-bottom: 20px;"><img src="/static/icon.png" alt="Askew"></div>
        
        <a href="/" class="sidebar-btn" style="width: 40px; height: 40px; padding: 0;" title="Back to Home">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </a>
        
        <button onclick="saveBot()" class="sidebar-btn primary" style="width: 40px; height: 40px; padding: 0;" title="Save Changes">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        </button>
        
        <div style="margin-top: auto; font-size: 10px; color: var(--text-muted);">{{ remaining_seconds // 60 }}m</div>
    </div>

    <!-- Intent List -->
    <div class="list-pane">
        <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle);">
            <h3 style="font-size: 16px; margin: 0 0 10px 0;">Intents</h3>
            <button class="btn btn-secondary" style="width: 100%;" onclick="createNewIntent()">+ New Intent</button>
        </div>
        <div style="flex: 1; overflow-y: auto; padding: 10px;" id="intent-list">
            <!-- JS will populate -->
        </div>
        <div style="padding: 16px; border-top: 1px solid var(--border-subtle); display: flex; flex-direction: column; gap: 8px;">
            <a href="/editor/{{ bot_id }}/reports" class="btn btn-secondary" style="width: 100%; font-size: 12px; text-align: center; text-decoration: none;">Unknown Reports</a>
            <button class="btn btn-secondary" style="width: 100%; font-size: 12px;" onclick="openSettings()">Bot Settings</button>
        </div>
    </div>

    <!-- Edit Area -->
    <div class="edit-pane" id="edit-area" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2>Edit Intent</h2>
            <button class="btn btn-secondary" style="color: #ef4444; border-color: rgba(239,68,68,0.3);" onclick="deleteCurrentIntent()">Delete</button>
        </div>

        <div class="field-group">
            <label style="display:block; margin-bottom:8px; font-weight:500;">Tag (Unique ID)</label>
            <input type="text" id="edit-tag" placeholder="e.g. greeting">
        </div>

        <div class="field-group">
            <label style="display:block; margin-bottom:8px; font-weight:500;">User Patterns (What they say)</label>
            <div id="edit-patterns"></div>
            <button class="btn btn-secondary" style="font-size: 12px; margin-top: 8px;" onclick="addPatternField('')">+ Add Pattern</button>
        </div>

        <div class="field-group">
            <label style="display:block; margin-bottom:8px; font-weight:500;">Bot Responses (Randomly chosen)</label>
            <div id="edit-responses"></div>
            <button class="btn btn-secondary" style="font-size: 12px; margin-top: 8px;" onclick="addResponseField('')">+ Add Response</button>
        </div>

        <div class="field-group">
            <label style="display:block; margin-bottom:8px; font-weight:500;">Optional Link Button</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="edit-link-title" placeholder="Button Label">
                <input type="text" id="edit-link-url" placeholder="https://...">
            </div>
        </div>
    </div>
    
    <div class="edit-pane" id="empty-state" style="display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted);">
        <p>Select an intent to edit or create a new one.</p>
    </div>

    <!-- Settings Modal (Hidden by default, simple overlay) -->
    <div id="settings-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;">
        <div class="card" style="width: 400px; max-width: 90%;">
            <h3>Bot Settings</h3>
            <label style="display:block; margin-top:10px;">Display Name</label>
            <input type="text" id="meta-name" value="{{ meta.name }}">
            
            <label style="display:block; margin-top:10px;">Password</label>
            <input type="text" id="meta-pass" value="{{ meta.password }}">

            <div style="margin-top:15px;">
                <label>
                    <input type="checkbox" id="meta-private" {{ 'checked' if meta.private else '' }}> Private (Hide from list)
                </label>
            </div>
            
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('settings-modal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const BOT_ID = "{{ bot_id }}";
        let intentsData = {{ intents | tojson }};
        let currentIntentIndex = -1;

        function renderList() {
            const list = document.getElementById('intent-list');
            list.innerHTML = '';
            intentsData.intents.forEach((intent, idx) => {
                const el = document.createElement('div');
                el.className = `intent-item ${idx === currentIntentIndex ? 'active' : ''}`;
                el.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span class="tag-badge">${intent.tag}</span>
                    </div>
                    <div style="font-size:12px; color:var(--text-muted); text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">
                        ${intent.patterns[0] || 'No patterns'}
                    </div>
                `;
                el.onclick = () => selectIntent(idx);
                list.appendChild(el);
            });
        }

        function selectIntent(idx) {
            // Save current if switching
            if (currentIntentIndex !== -1) updateCurrentFromUI();
            
            currentIntentIndex = idx;
            const intent = intentsData.intents[idx];
            
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('edit-area').style.display = 'block';
            
            document.getElementById('edit-tag').value = intent.tag;
            
            // Patterns
            const patContainer = document.getElementById('edit-patterns');
            patContainer.innerHTML = '';
            intent.patterns.forEach(p => addPatternField(p));
            
            // Responses
            const resContainer = document.getElementById('edit-responses');
            resContainer.innerHTML = '';
            intent.responses.forEach(r => addResponseField(r));
            
            // Link
            if (intent.link) {
                document.getElementById('edit-link-title').value = intent.link.title || '';
                document.getElementById('edit-link-url').value = intent.link.url || '';
            } else {
                document.getElementById('edit-link-title').value = '';
                document.getElementById('edit-link-url').value = '';
            }
            
            renderList(); // Update active state
        }

        function addPatternField(val) {
            const div = document.createElement('div');
            div.className = 'array-input';
            div.innerHTML = `<input type="text" class="pat-input" value="${val.replace(/"/g, '&quot;')}" onchange="updateCurrentFromUI()"><button class="btn btn-secondary" onclick="this.parentElement.remove(); updateCurrentFromUI()">X</button>`;
            document.getElementById('edit-patterns').appendChild(div);
        }

        function addResponseField(val) {
            const div = document.createElement('div');
            div.className = 'array-input';
            div.innerHTML = `<input type="text" class="res-input" value="${val.replace(/"/g, '&quot;')}" onchange="updateCurrentFromUI()"><button class="btn btn-secondary" onclick="this.parentElement.remove(); updateCurrentFromUI()">X</button>`;
            document.getElementById('edit-responses').appendChild(div);
        }

        function updateCurrentFromUI() {
            if (currentIntentIndex === -1) return;
            
            const intent = intentsData.intents[currentIntentIndex];
            intent.tag = document.getElementById('edit-tag').value;
            
            intent.patterns = Array.from(document.getElementsByClassName('pat-input')).map(i => i.value).filter(v => v);
            intent.responses = Array.from(document.getElementsByClassName('res-input')).map(i => i.value).filter(v => v);
            
            const linkTitle = document.getElementById('edit-link-title').value;
            const linkUrl = document.getElementById('edit-link-url').value;
            
            if (linkTitle || linkUrl) {
                intent.link = { title: linkTitle, url: linkUrl };
            } else {
                delete intent.link;
            }
        }

        function createNewIntent() {
            if (currentIntentIndex !== -1) updateCurrentFromUI();
            
            intentsData.intents.unshift({
                tag: "new_intent_" + Math.floor(Math.random()*1000),
                patterns: [],
                responses: []
            });
            renderList();
            selectIntent(0);
        }
        
        function deleteCurrentIntent() {
            if(!confirm("Delete this intent?")) return;
            intentsData.intents.splice(currentIntentIndex, 1);
            currentIntentIndex = -1;
            document.getElementById('edit-area').style.display = 'none';
            document.getElementById('empty-state').style.display = 'flex';
            renderList();
        }

        async function saveBot() {
            if (currentIntentIndex !== -1) updateCurrentFromUI();
            
            try {
                const res = await fetch(`/editor/${BOT_ID}/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(intentsData)
                });
                if(res.ok) alert("Saved!");
                else alert("Save failed");
            } catch(e) { alert("Network Error"); }
        }

        // Settings
        function openSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
        }
        
        async function saveSettings() {
            const payload = {
                name: document.getElementById('meta-name').value,
                password: document.getElementById('meta-pass').value,
                private: document.getElementById('meta-private').checked
            };
            
            await fetch(`/editor/${BOT_ID}/save-meta`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            document.getElementById('settings-modal').style.display = 'none';
            alert("Settings Saved");
        }

        // Init
        renderList();
    </script>
</body>
</html>